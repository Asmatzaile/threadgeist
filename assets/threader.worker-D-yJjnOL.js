(function(){"use strict";function S(e){const t=+this._x.call(null,e),i=+this._y.call(null,e);return k(this.cover(t,i),t,i,e)}function k(e,t,i,n){if(isNaN(t)||isNaN(i))return e;var s,r=e._root,h={data:n},f=e._x0,o=e._y0,l=e._x1,a=e._y1,u,c,_,x,d,y,p,g;if(!r)return e._root=h,e;for(;r.length;)if((d=t>=(u=(f+l)/2))?f=u:l=u,(y=i>=(c=(o+a)/2))?o=c:a=c,s=r,!(r=r[p=y<<1|d]))return s[p]=h,e;if(_=+e._x.call(null,r.data),x=+e._y.call(null,r.data),t===_&&i===x)return h.next=r,s?s[p]=h:e._root=h,e;do s=s?s[p]=new Array(4):e._root=new Array(4),(d=t>=(u=(f+l)/2))?f=u:l=u,(y=i>=(c=(o+a)/2))?o=c:a=c;while((p=y<<1|d)===(g=(x>=c)<<1|_>=u));return s[g]=r,s[p]=h,e}function j(e){var t,i,n=e.length,s,r,h=new Array(n),f=new Array(n),o=1/0,l=1/0,a=-1/0,u=-1/0;for(i=0;i<n;++i)isNaN(s=+this._x.call(null,t=e[i]))||isNaN(r=+this._y.call(null,t))||(h[i]=s,f[i]=r,s<o&&(o=s),s>a&&(a=s),r<l&&(l=r),r>u&&(u=r));if(o>a||l>u)return this;for(this.cover(o,l).cover(a,u),i=0;i<n;++i)k(this,h[i],f[i],e[i]);return this}function C(e,t){if(isNaN(e=+e)||isNaN(t=+t))return this;var i=this._x0,n=this._y0,s=this._x1,r=this._y1;if(isNaN(i))s=(i=Math.floor(e))+1,r=(n=Math.floor(t))+1;else{for(var h=s-i||1,f=this._root,o,l;i>e||e>=s||n>t||t>=r;)switch(l=(t<n)<<1|e<i,o=new Array(4),o[l]=f,f=o,h*=2,l){case 0:s=i+h,r=n+h;break;case 1:i=s-h,r=n+h;break;case 2:s=i+h,n=r-h;break;case 3:i=s-h,n=r-h;break}this._root&&this._root.length&&(this._root=f)}return this._x0=i,this._y0=n,this._x1=s,this._y1=r,this}function D(){var e=[];return this.visit(function(t){if(!t.length)do e.push(t.data);while(t=t.next)}),e}function O(e){return arguments.length?this.cover(+e[0][0],+e[0][1]).cover(+e[1][0],+e[1][1]):isNaN(this._x0)?void 0:[[this._x0,this._y0],[this._x1,this._y1]]}function w(e,t,i,n,s){this.node=e,this.x0=t,this.y0=i,this.x1=n,this.y1=s}function Q(e,t,i){var n,s=this._x0,r=this._y0,h,f,o,l,a=this._x1,u=this._y1,c=[],_=this._root,x,d;for(_&&c.push(new w(_,s,r,a,u)),i==null?i=1/0:(s=e-i,r=t-i,a=e+i,u=t+i,i*=i);x=c.pop();)if(!(!(_=x.node)||(h=x.x0)>a||(f=x.y0)>u||(o=x.x1)<s||(l=x.y1)<r))if(_.length){var y=(h+o)/2,p=(f+l)/2;c.push(new w(_[3],y,p,o,l),new w(_[2],h,p,y,l),new w(_[1],y,f,o,p),new w(_[0],h,f,y,p)),(d=(t>=p)<<1|e>=y)&&(x=c[c.length-1],c[c.length-1]=c[c.length-1-d],c[c.length-1-d]=x)}else{var g=e-+this._x.call(null,_.data),M=t-+this._y.call(null,_.data),N=g*g+M*M;if(N<i){var m=Math.sqrt(i=N);s=e-m,r=t-m,a=e+m,u=t+m,n=_.data}}return n}function W(e){if(isNaN(a=+this._x.call(null,e))||isNaN(u=+this._y.call(null,e)))return this;var t,i=this._root,n,s,r,h=this._x0,f=this._y0,o=this._x1,l=this._y1,a,u,c,_,x,d,y,p;if(!i)return this;if(i.length)for(;;){if((x=a>=(c=(h+o)/2))?h=c:o=c,(d=u>=(_=(f+l)/2))?f=_:l=_,t=i,!(i=i[y=d<<1|x]))return this;if(!i.length)break;(t[y+1&3]||t[y+2&3]||t[y+3&3])&&(n=t,p=y)}for(;i.data!==e;)if(s=i,!(i=i.next))return this;return(r=i.next)&&delete i.next,s?(r?s.next=r:delete s.next,this):t?(r?t[y]=r:delete t[y],(i=t[0]||t[1]||t[2]||t[3])&&i===(t[3]||t[2]||t[1]||t[0])&&!i.length&&(n?n[p]=i:this._root=i),this):(this._root=r,this)}function E(e){for(var t=0,i=e.length;t<i;++t)this.remove(e[t]);return this}function R(){return this._root}function U(){var e=0;return this.visit(function(t){if(!t.length)do++e;while(t=t.next)}),e}function $(e){var t=[],i,n=this._root,s,r,h,f,o;for(n&&t.push(new w(n,this._x0,this._y0,this._x1,this._y1));i=t.pop();)if(!e(n=i.node,r=i.x0,h=i.y0,f=i.x1,o=i.y1)&&n.length){var l=(r+f)/2,a=(h+o)/2;(s=n[3])&&t.push(new w(s,l,a,f,o)),(s=n[2])&&t.push(new w(s,r,a,l,o)),(s=n[1])&&t.push(new w(s,l,h,f,a)),(s=n[0])&&t.push(new w(s,r,h,l,a))}return this}function B(e){var t=[],i=[],n;for(this._root&&t.push(new w(this._root,this._x0,this._y0,this._x1,this._y1));n=t.pop();){var s=n.node;if(s.length){var r,h=n.x0,f=n.y0,o=n.x1,l=n.y1,a=(h+o)/2,u=(f+l)/2;(r=s[0])&&t.push(new w(r,h,f,a,u)),(r=s[1])&&t.push(new w(r,a,f,o,u)),(r=s[2])&&t.push(new w(r,h,u,a,l)),(r=s[3])&&t.push(new w(r,a,u,o,l))}i.push(n)}for(;n=i.pop();)e(n.node,n.x0,n.y0,n.x1,n.y1);return this}function F(e){return e[0]}function G(e){return arguments.length?(this._x=e,this):this._x}function H(e){return e[1]}function J(e){return arguments.length?(this._y=e,this):this._y}function q(e,t,i){var n=new A(t??F,i??H,NaN,NaN,NaN,NaN);return e==null?n:n.addAll(e)}function A(e,t,i,n,s,r){this._x=e,this._y=t,this._x0=i,this._y0=n,this._x1=s,this._y1=r,this._root=void 0}function T(e){for(var t={data:e.data},i=t;e=e.next;)i=i.next={data:e.data};return t}var v=q.prototype=A.prototype;v.copy=function(){var e=new A(this._x,this._y,this._x0,this._y0,this._x1,this._y1),t=this._root,i,n;if(!t)return e;if(!t.length)return e._root=T(t),e;for(i=[{source:t,target:e._root=new Array(4)}];t=i.pop();)for(var s=0;s<4;++s)(n=t.source[s])&&(n.length?i.push({source:n,target:t.target[s]=new Array(4)}):t.target[s]=T(n));return e},v.add=S,v.addAll=j,v.cover=C,v.data=D,v.extent=O,v.find=Q,v.remove=W,v.removeAll=E,v.root=R,v.size=U,v.visit=$,v.visitAfter=B,v.x=G,v.y=J;function K(e,t,i,n,s){const r=[],h=n*n,f=s?o=>s(o)&&r.push(o):o=>r.push(o);return e.visit(function(o,l,a,u,c){if(o.length)return l>=t+n||a>=i+n||u<t-n||c<i-n;const _=+e._x.call(null,o.data)-t,x=+e._y.call(null,o.data)-i;if(_*_+x*x<h)do f(o.data);while(o=o.next)}),r}class L{constructor(t){this.duration=t}start(){this.startTime=performance.now()}get isOver(){return this.elapsedTime>this.duration}get elapsedTime(){return performance.now()-this.startTime}}const V=(e,t,i)=>t+e*(i-t),X=e=>new Promise(t=>setTimeout(t,e));self.onmessage=e=>{const{data:{name:t,args:i}}=e;if(P[t])return P[t](i);console.error(`Unknown method: ${t}`)};const b=new Set;let I;async function Y({points:e,route:t,settings:i}){I=!1,t=[];const n=[],s=e.length/2;for(let a=0;a<s;a++)n.push([e[a*2],e[a*2+1],a]);const r=q(n);b.clear();let h=Math.floor(Math.random()*s),f,o;const l=new L(200);l.start();for(let a=0;a<s;a++){t.push(h),b.add(h),self.postMessage({route:t});const u=e[h*2],c=e[h*2+1],_=a!==0?Math.atan2(c-o,u-f):Math.random()*Math.PI*2;if(h=z(r,[u,c],_,i),h===void 0||(f=u,o=c,l.isOver&&(l.start(),await X(0),I)))break}self.postMessage({finished:!0,route:t})}function Z(){I=!0}const P={calculateRoute:Y,stop:Z};function z(e,[t,i],n,s){const{maxDistance:r,closenessWeight:h,directnessWeight:f,randomness:o}=s,l=K(e,t,i,r/2,([_,x,d])=>!b.has(d));let a=0,u;const c=r*r;return l.forEach(([_,x,d])=>{const y=(_-t)**2+(x-i)**2,p=Math.atan2(x-i,_-t),g=Math.min(1,Math.cos(p-n)/2+.5+.01),M=Math.min(1-y/c+.01);let N=(Math.pow(M,h)+Math.pow(g,f))/2;N=V(o,N,Math.random()),!(N<=a)&&(u=d,a=N)}),u}})();
